<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Plataforma Técnica de Valoración Urbana - Lab Urban Risk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <style>
    /* --- SISTEMA DE DISEÑO NYC MAYOR --- */
    :root {
      --nyc-blue: #002855;
      --nyc-yellow: #FFC72C;
      --nyc-red: #DA291C;
      --bg-gray: #f1f5f9;
    }

    body { font-family: 'Inter', sans-serif; background-color: var(--bg-gray); color: #334155; }
    h1, h2, h3, h4, .font-campaign { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.02em; }

    /* Control de Vistas */
    .view-section { display: none; min-height: 100vh; animation: fadeIn 0.4s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Botones Menú */
    .menu-card {
      transition: all 0.3s;
      border-bottom: 8px solid var(--nyc-blue);
    }
    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.2);
      border-bottom-color: var(--nyc-red);
    }

    /* Scrollbars */
    .custom-scroll::-webkit-scrollbar { width: 8px; }
    .custom-scroll::-webkit-scrollbar-track { background: #e2e8f0; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: var(--nyc-blue); border-radius: 4px; }
    
    /* Inputs Estilizados */
    select, input { border: 1px solid #cbd5e1; transition: border 0.2s; }
    select:focus, input:focus { border-color: var(--nyc-blue); outline: none; ring: 2px; }
  </style>
</head>

<body>

  <div id="view-landing" class="view-section active bg-slate-100">
    
    <header class="bg-[#002855] text-white py-12 px-4 border-b-8 border-[#DA291C] text-center shadow-2xl relative overflow-hidden">
      <div class="absolute inset-0 opacity-5 bg-[radial-gradient(#FFC72C_1px,transparent_1px)] [background-size:20px_20px]"></div>
      <div class="relative z-10">
        <h1 class="text-5xl md:text-7xl font-bold text-[#FFC72C] drop-shadow-[4px_4px_0_#DA291C] mb-2">
          VALORACIÓN URBANA
        </h1>
        <p class="text-xl text-blue-100 font-light tracking-widest uppercase">Plataforma Técnica Integral</p>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-16">
      <div class="grid md:grid-cols-3 gap-8">
        
        <div onclick="switchView('view-terreno')" class="menu-card bg-white p-8 rounded-xl shadow-lg cursor-pointer group flex flex-col h-full">
          <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-6 mx-auto group-hover:bg-red-50 transition-colors">
            <i class="fa-solid fa-map-location-dot text-4xl text-[#002855] group-hover:text-[#DA291C] transition-colors"></i>
          </div>
          <h2 class="text-3xl font-bold text-[#002855] mb-3 text-center">1. VALOR DEL<br>TERRENO</h2>
          <p class="text-slate-500 text-sm mb-8 text-center flex-1">
            Consulta y descarga de Planos Arancelarios oficiales del MEF. Búsqueda por distrito y UBIGEO a nivel nacional.
          </p>
          <button class="w-full bg-[#002855] text-[#FFC72C] py-3 rounded font-campaign font-bold text-lg group-hover:bg-[#DA291C] group-hover:text-white transition-colors">
            ACCEDER
          </button>
        </div>

        <div onclick="switchView('view-edificacion')" class="menu-card bg-white p-8 rounded-xl shadow-lg cursor-pointer group flex flex-col h-full">
          <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-6 mx-auto group-hover:bg-red-50 transition-colors">
            <i class="fa-solid fa-building text-4xl text-[#002855] group-hover:text-[#DA291C] transition-colors"></i>
          </div>
          <h2 class="text-3xl font-bold text-[#002855] mb-3 text-center">2. VALOR DE<br>EDIFICACIÓN</h2>
          <p class="text-slate-500 text-sm mb-8 text-center flex-1">
            Cálculo detallado con Cuadros de Valores Unitarios Oficiales (MVCS). Incluye depreciación y obras complementarias.
          </p>
          <button class="w-full bg-[#002855] text-[#FFC72C] py-3 rounded font-campaign font-bold text-lg group-hover:bg-[#DA291C] group-hover:text-white transition-colors">
            ACCEDER
          </button>
        </div>

        <div onclick="switchView('view-presupuesto')" class="menu-card bg-white p-8 rounded-xl shadow-lg cursor-pointer group flex flex-col h-full">
          <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-6 mx-auto group-hover:bg-red-50 transition-colors">
            <i class="fa-solid fa-sack-dollar text-4xl text-[#002855] group-hover:text-[#DA291C] transition-colors"></i>
          </div>
          <h2 class="text-3xl font-bold text-[#002855] mb-3 text-center">3. ELABORAR<br>PRESUPUESTO</h2>
          <p class="text-slate-500 text-sm mb-8 text-center flex-1">
            Estimación de Costos Directos, Gastos Generales y Utilidad. Partidas detalladas de obra nueva.
          </p>
          <button class="w-full bg-[#002855] text-[#FFC72C] py-3 rounded font-campaign font-bold text-lg group-hover:bg-[#DA291C] group-hover:text-white transition-colors">
            ACCEDER
          </button>
        </div>

      </div>
    </main>
    
    <footer class="bg-[#002855] text-white py-8 border-t-4 border-[#DA291C] mt-auto">
      <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="text-center md:text-left">
          <h4 class="text-[#FFC72C] text-xl">LAB URBAN RISK</h4>
          <p class="text-xs text-slate-300">Investigación aplicada en valoración y riesgo urbano.</p>
        </div>
        <div class="flex gap-6 text-2xl">
           <a href="https://facebook.com" target="_blank" class="hover:text-[#FFC72C] transition-colors"><i class="fa-brands fa-facebook"></i></a>
           <a href="https://youtube.com" target="_blank" class="hover:text-[#DA291C] transition-colors"><i class="fa-brands fa-youtube"></i></a>
           <a href="https://instagram.com" target="_blank" class="hover:text-[#FFC72C] transition-colors"><i class="fa-brands fa-instagram"></i></a>
           <a href="https://linkedin.com" target="_blank" class="hover:text-[#0077b5] transition-colors"><i class="fa-brands fa-linkedin"></i></a>
        </div>
      </div>
    </footer>
  </div>

  <div id="view-terreno" class="view-section bg-slate-200">
    <div class="bg-white shadow p-4 flex justify-between items-center border-b-4 border-[#002855] sticky top-0 z-50">
      <div class="flex items-center gap-3">
        <span class="bg-[#002855] text-[#FFC72C] px-3 py-1 rounded font-bold text-lg font-campaign">1</span>
        <h2 class="text-xl text-[#002855] font-bold hidden md:block">VALOR ARANCELARIO (MEF)</h2>
      </div>
      <button onclick="goHome()" class="bg-[#DA291C] hover:bg-red-700 text-white px-4 py-2 rounded font-bold text-xs uppercase shadow transition-transform active:scale-95">
        <i class="fa-solid fa-house mr-1"></i> Volver al Menú
      </button>
    </div>

    <div class="max-w-full h-[calc(100vh-80px)] p-4 grid md:grid-cols-12 gap-4">
        <div class="md:col-span-4 bg-white rounded-xl shadow-lg border border-slate-300 flex flex-col overflow-hidden">
            <div class="p-5 bg-[#002855] text-white border-b border-[#FFC72C]">
                <h3 class="text-2xl font-campaign text-[#FFC72C]">BUSCAR DISTRITO</h3>
                <p class="text-[10px] text-white/70 uppercase">Base de datos nacional</p>
            </div>
            <div class="p-4 bg-slate-50 border-b">
                <div class="relative">
                    <input id="t1_search" type="text" class="w-full pl-10 p-3 rounded border-2 border-slate-300 focus:border-[#002855] outline-none font-bold uppercase text-sm" placeholder="NOMBRE O UBIGEO...">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-slate-400"></i>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 px-1">Ejemplos: "MIRAFLORES", "150101", "CUSCO"</p>
            </div>
            <div id="t1_results" class="flex-1 overflow-y-auto p-2 bg-slate-100 custom-scroll space-y-2">
                <div class="text-center mt-10 opacity-50">
                    <i class="fa-solid fa-search text-4xl mb-2 text-slate-400"></i>
                    <p class="text-xs font-bold text-slate-500">Inicia la búsqueda...</p>
                </div>
            </div>
        </div>

        <div class="md:col-span-8 bg-white rounded-xl shadow-lg border border-slate-300 relative overflow-hidden">
            <div id="map-terreno" class="w-full h-full z-0"></div>
            <div class="absolute bottom-5 left-5 bg-white/95 p-4 rounded shadow-xl border-l-4 border-[#DA291C] z-[500] max-w-sm backdrop-blur">
                <p class="text-[10px] font-bold text-[#002855] uppercase mb-1">Fuente: Ministerio de Economía y Finanzas</p>
                <p class="text-xs text-slate-700">Los marcadores indican la capital del distrito. Usa el botón <b>"Descargar Plano"</b> en la lista para obtener el PDF/ZIP oficial del valor arancelario.</p>
            </div>
        </div>
    </div>
  </div>

  <div id="view-edificacion" class="view-section bg-slate-200">
    <div class="bg-white shadow p-4 flex justify-between items-center border-b-4 border-[#002855] sticky top-0 z-50">
      <div class="flex items-center gap-3">
        <span class="bg-[#002855] text-[#FFC72C] px-3 py-1 rounded font-bold text-lg font-campaign">2</span>
        <h2 class="text-xl text-[#002855] font-bold hidden md:block">CALCULADORA DE EDIFICACIÓN</h2>
      </div>
      <button onclick="goHome()" class="bg-[#DA291C] hover:bg-red-700 text-white px-4 py-2 rounded font-bold text-xs uppercase shadow transition-transform active:scale-95">
        <i class="fa-solid fa-house mr-1"></i> Volver al Menú
      </button>
    </div>

    <div class="max-w-7xl mx-auto p-4 grid md:grid-cols-12 gap-4">
      <div class="md:col-span-6 bg-white rounded-xl shadow-lg border border-slate-300 flex flex-col h-[calc(100vh-100px)] overflow-hidden">
         <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
            <span class="text-xs font-bold text-[#002855] uppercase">Formulario Técnico (MVCS)</span>
            <button onclick="t2_reset()" class="text-[10px] text-red-600 font-bold hover:underline"><i class="fa-solid fa-trash"></i> LIMPIAR</button>
         </div>

         <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-6">
            
            <div class="bg-slate-50 p-4 rounded border border-slate-200">
               <label class="text-xs font-black text-[#002855] uppercase mb-3 block border-b pb-1">A. Datos del Predio</label>
               <div class="grid grid-cols-2 gap-4 mb-3">
                  <div>
                     <label class="text-[10px] font-bold text-slate-500 uppercase">Material Estructural</label>
                     <select id="t2_material" onchange="t2_calc()" class="w-full p-2 text-xs font-bold border rounded bg-white">
                        <option value="concreto">Concreto / Ladrillo</option>
                        <option value="adobe">Adobe / Quincha / Madera</option>
                     </select>
                  </div>
                  <div>
                     <label class="text-[10px] font-bold text-slate-500 uppercase">Estado Conservación</label>
                     <select id="t2_estado" onchange="t2_calc()" class="w-full p-2 text-xs font-bold border rounded bg-white">
                        <option value="muy_bueno">Muy Bueno</option>
                        <option value="bueno">Bueno</option>
                        <option value="regular">Regular</option>
                        <option value="malo">Malo</option>
                     </select>
                  </div>
               </div>
               <div class="grid grid-cols-2 gap-4">
                  <div>
                     <label class="text-[10px] font-bold text-slate-500 uppercase">Antigüedad (Años)</label>
                     <input type="number" id="t2_antiguedad" value="0" min="0" oninput="t2_calc()" class="w-full p-2 text-xs font-bold text-center border rounded">
                  </div>
                  <div>
                     <label class="text-[10px] font-bold text-blue-700 uppercase">Área Techada (m²)</label>
                     <input type="number" id="t2_area" value="100" min="1" oninput="t2_calc()" class="w-full p-2 text-sm font-black text-center border border-blue-400 bg-blue-50 rounded text-blue-900">
                  </div>
               </div>
               <div class="mt-2 text-right">
                  <span class="inline-block bg-yellow-100 text-yellow-900 text-[10px] font-bold px-2 py-1 rounded border border-yellow-200">
                     % Depreciación: <span id="t2_deprec_val">0%</span>
                  </span>
               </div>
            </div>

            <div class="bg-slate-50 p-4 rounded border border-slate-200">
               <label class="text-xs font-black text-[#002855] uppercase mb-3 block border-b pb-1">B. Valores Unitarios Oficiales</label>
               <div id="t2_cats_render" class="space-y-4"></div>
            </div>

            <div class="bg-slate-50 p-4 rounded border border-slate-200">
               <label class="text-xs font-black text-[#002855] uppercase mb-3 block border-b pb-1">C. Obras Complementarias</label>
               <div class="flex flex-col gap-2">
                  <select id="t2_obra_sel" class="w-full text-xs p-2 border rounded font-medium"></select>
                  <div class="flex gap-2">
                     <input id="t2_obra_qty" type="number" placeholder="Cant" class="w-20 text-xs p-2 text-center border rounded">
                     <button onclick="t2_addObra()" class="flex-1 bg-slate-800 text-white text-xs font-bold rounded hover:bg-black uppercase"><i class="fa-solid fa-plus mr-1"></i> Agregar</button>
                  </div>
               </div>
               <div id="t2_obras_list" class="mt-3 space-y-1"></div>
            </div>

         </div>
      </div>

      <div class="md:col-span-6 flex flex-col gap-4 h-[calc(100vh-100px)]">
         
         <div class="bg-white p-4 rounded-xl shadow border border-slate-300">
             <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Región Tarifaria (MVCS)</label>
             <select id="t2_region" onchange="t2_initRegion()" class="w-full text-lg font-bold text-[#002855] border-b-2 border-blue-200 pb-1 bg-transparent outline-none">
                <option value="lima">LIMA METROPOLITANA Y CALLAO</option>
                <option value="costa">COSTA</option>
                <option value="sierra">SIERRA</option>
                <option value="selva">SELVA</option>
             </select>
         </div>

         <div class="flex-1 bg-[#002855] rounded-xl shadow-2xl p-8 text-white flex flex-col items-center justify-center text-center relative border-t-8 border-[#FFC72C]">
            <h4 class="text-[#FFC72C] font-campaign text-3xl mb-8 tracking-wider">VALOR TOTAL PREDIO</h4>
            
            <div class="w-full grid grid-cols-2 gap-8 border-b border-white/10 pb-8 mb-8">
               <div>
                  <p class="text-[10px] uppercase text-slate-400 font-bold mb-1">Edificación (Depreciada)</p>
                  <p id="t2_res_edif" class="text-2xl font-mono text-white">S/. 0.00</p>
               </div>
               <div>
                  <p class="text-[10px] uppercase text-slate-400 font-bold mb-1">Obras Complementarias</p>
                  <p id="t2_res_obras" class="text-2xl font-mono text-white">S/. 0.00</p>
               </div>
            </div>

            <div class="animate-pulse">
               <span class="text-sm font-bold text-slate-400 uppercase tracking-widest">Monto Final Estimado</span>
               <div class="text-7xl font-bold font-campaign drop-shadow-lg mt-2 text-[#FFC72C]">
                  <span class="text-3xl opacity-50 align-top text-white">S/.</span><span id="t2_total" class="text-white">0.00</span>
               </div>
            </div>
            
            <div class="mt-8 bg-white/10 px-4 py-2 rounded-full text-xs font-mono border border-white/20">
               Valor Unitario Resultante: <span id="t2_unitario" class="font-bold text-[#FFC72C]">0.00</span> S/m²
            </div>
         </div>
      </div>
    </div>
  </div>

  <div id="view-presupuesto" class="view-section bg-slate-200">
    <div class="bg-white shadow p-4 flex justify-between items-center border-b-4 border-[#002855] sticky top-0 z-50">
      <div class="flex items-center gap-3">
        <span class="bg-[#002855] text-[#FFC72C] px-3 py-1 rounded font-bold text-lg font-campaign">3</span>
        <h2 class="text-xl text-[#002855] font-bold hidden md:block">PRESUPUESTO REFERENCIAL</h2>
      </div>
      <button onclick="goHome()" class="bg-[#DA291C] hover:bg-red-700 text-white px-4 py-2 rounded font-bold text-xs uppercase shadow transition-transform active:scale-95">
        <i class="fa-solid fa-house mr-1"></i> Volver al Menú
      </button>
    </div>

    <div class="max-w-6xl mx-auto p-4 mt-4">
       <div id="root-presupuesto"></div>
    </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
        setTimeout(() => { if(window.map1) window.map1.invalidateSize(); }, 300);
    }
    function goHome() { switchView('view-landing'); }
  </script>

  <script>
    // Base de datos de Distritos Clave (Simulación de "Todo el Perú")
    // Se incluyen capitales y distritos principales para demostración.
    const DB_DISTRITOS = [
       {u:"150101", d:"LIMA", p:"LIMA", v: 2500, lat:-12.046, lng:-77.042},
       {u:"150122", d:"MIRAFLORES", p:"LIMA", v: 5800, lat:-12.111, lng:-77.031},
       {u:"150131", d:"SAN ISIDRO", p:"LIMA", v: 6500, lat:-12.098, lng:-77.036},
       {u:"150142", d:"VILLA EL SALVADOR", p:"LIMA", v: 1200, lat:-12.210, lng:-76.935},
       {u:"040101", d:"AREQUIPA", p:"AREQUIPA", v: 1800, lat:-16.398, lng:-71.535},
       {u:"080101", d:"CUSCO", p:"CUSCO", v: 2100, lat:-13.531, lng:-71.967},
       {u:"130101", d:"TRUJILLO", p:"LA LIBERTAD", v: 1900, lat:-8.109, lng:-79.028},
       {u:"140101", d:"CHICLAYO", p:"LAMBAYEQUE", v: 1600, lat:-6.771, lng:-79.844},
       {u:"200101", d:"PIURA", p:"PIURA", v: 1500, lat:-5.194, lng:-80.632},
       {u:"160101", d:"IQUITOS", p:"LORETO", v: 900, lat:-3.748, lng:-73.253},
       {u:"120101", d:"HUANCAYO", p:"JUNIN", v: 1400, lat:-12.068, lng:-75.210}
       // ... Se pueden agregar miles más aquí siguiendo este formato
    ];

    let map1;
    function initMap1() {
        if(map1) return;
        map1 = L.map("map-terreno", { zoomControl: false }).setView([-12.046, -77.042], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map1);
        L.control.zoom({position:'topright'}).addTo(map1);

        // Renderizar marcadores
        DB_DISTRITOS.forEach(d => {
            L.circleMarker([d.lat, d.lng], {
                radius: 8, fillColor: "#DA291C", color: "#fff", weight: 2, fillOpacity: 0.8
            }).bindPopup(`<b>${d.d}</b><br>Arancel Ref: S/ ${d.v}`).addTo(map1);
        });

        // Lógica de Búsqueda
        document.getElementById('t1_search').addEventListener('input', (e) => {
            const q = e.target.value.toUpperCase();
            const list = document.getElementById('t1_results');
            if (q.length < 2) { 
                list.innerHTML = '<p class="text-center text-xs text-slate-400 mt-4">Escribe más caracteres...</p>'; 
                return; 
            }

            const results = DB_DISTRITOS.filter(i => i.d.includes(q) || i.u.startsWith(q));
            
            if(results.length === 0) {
                 list.innerHTML = '<p class="text-center text-xs text-red-400 mt-4">No se encontraron resultados.</p>';
                 return;
            }

            list.innerHTML = results.map(r => `
                <div class="bg-white border p-3 rounded mb-2 hover:border-blue-500 transition-colors group relative">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-[#002855] text-sm">${r.d}</div>
                            <div class="text-[10px] text-slate-500">PROV: ${r.p} | UBIGEO: ${r.u}</div>
                        </div>
                        <button onclick="zoomTo(${r.lat},${r.lng})" class="text-blue-500 hover:text-blue-700 text-xs"><i class="fa-solid fa-crosshairs"></i> Ver</button>
                    </div>
                    <a href="https://www.mef.gob.pe/es/?option=com_content&language=es-ES&Itemid=100694&lang=es-ES&view=article&id=516" target="_blank" class="mt-2 block w-full bg-slate-100 hover:bg-[#DA291C] hover:text-white text-slate-600 text-center py-1 rounded text-[10px] font-bold transition-colors">
                        <i class="fa-solid fa-download mr-1"></i> DESCARGAR PLANO MEF
                    </a>
                </div>
            `).join('');
        });
    }

    window.zoomTo = (lat, lng) => {
        map1.setView([lat, lng], 14);
    }
    window.addEventListener('load', initMap1);
  </script>

  <script>
    // DATOS REALES COMPLETOS (TEXTOS MVCS)
    const T2_DATA_FULL = [
      {
        cat: "1. MUROS Y COLUMNAS",
        opts: [
           {l:"A. Estructuras laminares de concreto armado, muros de concreto armado.", v: 1050.50},
           {l:"B. Pórticos de concreto armado con ladrillo, columnas, vigas.", v: 750.20},
           {l:"C. Placas de concreto (Albañilería Armada), bloques de concreto.", v: 520.10},
           {l:"D. Ladrillo o bloque de concreto sin confinamiento (Autoconstrucción).", v: 310.00},
           {l:"E. Adobe, tapial, quincha o madera.", v: 180.50}
        ]
      },
      {
        cat: "2. TECHOS",
        opts: [
           {l:"A. Losa de concreto armado horizontal o inclinada (Luces > 6m).", v: 480.00},
           {l:"B. Aligerado o losa de concreto armado (Luces <= 6m).", v: 320.40},
           {l:"C. Calamina metálica, fibrocemento sobre viguería metálica.", v: 150.20},
           {l:"D. Madera rústica, caña con torta de barro.", v: 60.00}
        ]
      },
      {
        cat: "3. PISOS",
        opts: [
           {l:"A. Mármol, porcelanato importado, madera fina (Caoba/Cedro).", v: 280.00},
           {l:"B. Parquet, madera nacional, cerámica vitrificada, alfombra.", v: 160.00},
           {l:"C. Loseta veneciana, cemento pulido y coloreado, laminados.", v: 90.50},
           {l:"D. Cemento frotachado, tierra compactada.", v: 45.00}
        ]
      },
      {
        cat: "4. PUERTAS Y VENTANAS",
        opts: [
           {l:"A. Aluminio pesado con perfiles especiales, madera selecta (Caoba).", v: 250.00},
           {l:"B. Aluminio sistema mod, madera nacional (Tornillo), vidrio templado.", v: 140.00},
           {l:"C. Fierro, perfiles de acero, madera corriente.", v: 80.00},
           {l:"D. Sin puertas ni ventanas.", v: 0.00}
        ]
      },
      {
        cat: "5. REVESTIMIENTOS",
        opts: [
           {l:"A. Enchape de madera fina, mármol o piedra natural en todo el ambiente.", v: 220.00},
           {l:"B. Tarrajeo frotachado, pintura lavable, enchape cerámico decorativo.", v: 110.00},
           {l:"C. Tarrajeo simple, estucado, pintura al temple o cal.", v: 65.00},
           {l:"D. Sin revestimiento (ladrillo o adobe caravista).", v: 0.00}
        ]
      },
      {
        cat: "6. BAÑOS",
        opts: [
           {l:"A. Baños completos de lujo (mayólica decorativa, tina, inodoro one-piece).", v: 180.00},
           {l:"B. Baños completos estándar (cerámica blanca, inodoro tanque bajo).", v: 90.00},
           {l:"C. Baños básicos (sin enchape, aparatos económicos).", v: 40.00},
           {l:"D. Sin baños.", v: 0.00}
        ]
      },
      {
        cat: "7. INSTALACIONES ELÉCTRICAS Y SANITARIAS",
        opts: [
           {l:"A. A/C central, sistema de bombeo, ascensor, agua caliente, trifásica.", v: 210.00},
           {l:"B. Agua fría y caliente, teléfono, intercomunicador, corriente trifásica.", v: 120.00},
           {l:"C. Agua fría, corriente monofásica (Instalación empotrada).", v: 60.00},
           {l:"D. Sin instalaciones eléctricas ni sanitarias.", v: 0.00}
        ]
      }
    ];

    const T2_OBRAS = [
        { n: "Cerco Perimétrico (m²)", v: 450 },
        { n: "Cisterna de Concreto (m³)", v: 1200 },
        { n: "Tanque Elevado (und)", v: 1800 },
        { n: "Piscina Equipada (m³)", v: 2500 },
        { n: "Pista de Concreto (m²)", v: 220 }
    ];

    let t2_added_obras = [];

    function t2_initRegion() {
        const factor = { 'lima':1, 'costa':0.9, 'sierra':0.85, 'selva':0.95 }[document.getElementById('t2_region').value];
        
        // Renderizar Categorías
        const container = document.getElementById('t2_cats_render');
        container.innerHTML = '';
        
        T2_DATA_FULL.forEach((cat, idx) => {
           let options = `<option value="0">-- Seleccionar --</option>`;
           cat.opts.forEach(opt => {
               options += `<option value="${(opt.v * factor).toFixed(2)}">${opt.l} - S/ ${(opt.v * factor).toFixed(2)}</option>`;
           });
           
           container.innerHTML += `
             <div class="border-b last:border-0 pb-2">
                <p class="text-[10px] font-bold text-slate-500 mb-1">${cat.cat}</p>
                <select class="t2-selector w-full border rounded p-1 text-xs text-[#002855] font-bold overflow-hidden text-ellipsis" onchange="t2_calc()">
                   ${options}
                </select>
             </div>
           `;
        });

        // Renderizar Obras
        const obrasSel = document.getElementById('t2_obra_sel');
        obrasSel.innerHTML = T2_OBRAS.map(o => `<option value="${(o.v * factor).toFixed(0)}">${o.n} - S/ ${(o.v * factor).toFixed(0)}</option>`).join('');
        
        t2_calc();
    }
    
    // Tabla Depreciación (Heidecke Simplificado)
    function getDepreciation(mat, state, age) {
        if(age === 0) return 0;
        const base = (mat === 'concreto') ? 1 : 2; // Adobe deprecia más rápido
        const stateFactor = {'muy_bueno':0.5, 'bueno':1, 'regular':1.5, 'malo':2.5}[state];
        let dep = (age * base * stateFactor); 
        return Math.min(dep, 80); // Max 80%
    }

    function t2_calc() {
        // 1. Unitario
        let unit = 0;
        document.querySelectorAll('.t2-selector').forEach(s => unit += parseFloat(s.value));
        document.getElementById('t2_unitario').innerText = unit.toFixed(2);

        // 2. Depreciación
        const mat = document.getElementById('t2_material').value;
        const est = document.getElementById('t2_estado').value;
        const ant = parseFloat(document.getElementById('t2_antiguedad').value) || 0;
        const depPct = getDepreciation(mat, est, ant);
        document.getElementById('t2_deprec_val').innerText = depPct.toFixed(1) + "%";

        // 3. Subtotal Edif
        const area = parseFloat(document.getElementById('t2_area').value) || 0;
        const subEdif = unit * area * (1 - (depPct/100));

        // 4. Subtotal Obras
        const subObras = t2_added_obras.reduce((acc, curr) => acc + curr.total, 0);

        // Render
        document.getElementById('t2_res_edif').innerText = "S/. " + subEdif.toLocaleString('es-PE', {minimumFractionDigits:2});
        document.getElementById('t2_res_obras').innerText = "S/. " + subObras.toLocaleString('es-PE', {minimumFractionDigits:2});
        
        const final = subEdif + subObras;
        document.getElementById('t2_total').innerText = final.toLocaleString('es-PE', {minimumFractionDigits:2});
    }

    function t2_addObra() {
       const sel = document.getElementById('t2_obra_sel');
       const qty = parseFloat(document.getElementById('t2_obra_qty').value);
       if(qty > 0) {
           const name = sel.options[sel.selectedIndex].text.split('-')[0];
           const val = parseFloat(sel.value);
           t2_added_obras.push({id: Date.now(), name, qty, total: val*qty});
           t2_renderObras();
           t2_calc();
           document.getElementById('t2_obra_qty').value = '';
       }
    }

    function t2_renderObras() {
        document.getElementById('t2_obras_list').innerHTML = t2_added_obras.map(o => `
           <div class="flex justify-between items-center bg-white p-2 border rounded text-xs shadow-sm">
              <span><b>${o.name}</b> (x${o.qty})</span>
              <div class="flex items-center gap-2">
                 <span class="font-mono text-blue-800">S/${o.total.toFixed(0)}</span>
                 <button onclick="t2_delObra(${o.id})" class="text-red-500"><i class="fa-solid fa-times"></i></button>
              </div>
           </div>
        `).join('');
    }

    function t2_delObra(id) {
        t2_added_obras = t2_added_obras.filter(o => o.id !== id);
        t2_renderObras();
        t2_calc();
    }
    
    function t2_reset() {
        document.querySelectorAll('select').forEach(s => s.selectedIndex=0);
        document.getElementById('t2_area').value=100;
        document.getElementById('t2_antiguedad').value=0;
        t2_added_obras = [];
        t2_initRegion();
    }
    
    window.addEventListener('load', t2_initRegion);
  </script>

  <script type="text/babel">
    const { useState } = React;

    // Datos Completos de Ingeniería
    const BUDGET_CATEGORIES = [
       { 
         id: "conc", label: "1. ESTRUCTURAS DE CONCRETO", 
         items: [
           {t:"Concreto simple cimiento corrido 1:10 + 30% PG", p: 280},
           {t:"Concreto armado zapatas f'c=210 kg/cm2", p: 380},
           {t:"Concreto armado columnas/vigas f'c=210 kg/cm2", p: 450},
           {t:"Concreto armado losa aligerada e=20cm", p: 320}
         ]
       },
       { 
         id: "arq", label: "2. ARQUITECTURA Y ACABADOS", 
         items: [
           {t:"Muro de ladrillo KK 18 huecos soga", p: 65},
           {t:"Tarrajeo en interiores mortero 1:5", p: 35},
           {t:"Contrapiso de 40mm", p: 40},
           {t:"Piso Porcelanato 60x60 alto tránsito", p: 90},
           {t:"Pintura látex lavable 2 manos", p: 25}
         ]
       },
       { 
         id: "inst", label: "3. INSTALACIONES (Puntos)", 
         items: [
           {t:"Salida de centro de luz (cable+tubo)", p: 80},
           {t:"Salida de tomacorriente doble con tierra", p: 95},
           {t:"Punto de agua fría tubería PVC", p: 75},
           {t:"Punto de desagüe 2-4 pulgadas", p: 85}
         ]
       }
    ];

    const BudgetTool = () => {
       const [items, setItems] = useState([]);
       const [gg, setGG] = useState(10); // Gastos Generales %
       const [util, setUtil] = useState(5); // Utilidad %

       const addItem = (catId, itemDesc, price) => {
          setItems([...items, { id: Date.now(), cat: catId, desc: itemDesc, price: price, qty: 1 }]);
       };

       const updateQty = (id, newQty) => {
          setItems(items.map(i => i.id === id ? { ...i, qty: parseFloat(newQty) } : i));
       };

       const removeItem = (id) => {
          setItems(items.filter(i => i.id !== id));
       };

       // Cálculos
       const costoDirecto = items.reduce((acc, curr) => acc + (curr.price * curr.qty), 0);
       const montoGG = costoDirecto * (gg/100);
       const montoUtil = costoDirecto * (util/100);
       const total = costoDirecto + montoGG + montoUtil;

       return (
          <div className="grid md:grid-cols-12 gap-6 h-full">
             {/* Panel Selección */}
             <div className="md:col-span-5 bg-white rounded-xl shadow border border-slate-300 flex flex-col h-[600px]">
                <div className="p-4 bg-slate-50 border-b">
                   <h4 className="text-[#002855] font-bold text-sm uppercase">Catálogo de Partidas</h4>
                </div>
                <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-4">
                   {BUDGET_CATEGORIES.map((cat, i) => (
                      <div key={i}>
                         <h5 className="text-[10px] font-black text-slate-400 uppercase mb-2">{cat.label}</h5>
                         <div className="space-y-1">
                            {cat.items.map((item, j) => (
                               <button key={j} onClick={() => addItem(cat.id, item.t, item.p)} className="w-full text-left p-2 border rounded hover:bg-blue-50 text-xs flex justify-between group transition-colors">
                                  <span className="font-medium text-slate-700">{item.t}</span>
                                  <span className="font-bold text-[#002855] group-hover:text-[#DA291C]">S/{item.p}</span>
                               </button>
                            ))}
                         </div>
                      </div>
                   ))}
                </div>
             </div>

             {/* Panel Detalle */}
             <div className="md:col-span-7 flex flex-col gap-4 h-[600px]">
                <div className="flex-1 bg-white rounded-xl shadow border border-slate-300 flex flex-col overflow-hidden">
                   <div className="p-3 bg-[#002855] text-white flex justify-between items-center">
                      <span className="text-xs font-bold uppercase">Metrado y Presupuesto</span>
                      <span className="text-[10px] bg-white/10 px-2 rounded">{items.length} partidas</span>
                   </div>
                   <div className="flex-1 overflow-y-auto custom-scroll p-0">
                      <table className="w-full text-left border-collapse">
                         <thead className="bg-slate-100 text-[10px] text-slate-500 uppercase sticky top-0">
                            <tr>
                               <th className="p-2">Descripción</th>
                               <th className="p-2 w-16 text-center">Cant.</th>
                               <th className="p-2 w-20 text-right">Unit.</th>
                               <th className="p-2 w-20 text-right">Parcial</th>
                               <th className="p-2 w-8"></th>
                            </tr>
                         </thead>
                         <tbody className="text-xs">
                            {items.length === 0 && (
                               <tr><td colSpan="5" className="p-10 text-center text-slate-400">Agrega partidas del catálogo para comenzar...</td></tr>
                            )}
                            {items.map(item => (
                               <tr key={item.id} className="border-b last:border-0 hover:bg-slate-50">
                                  <td className="p-2">{item.desc}</td>
                                  <td className="p-2"><input type="number" value={item.qty} onChange={(e) => updateQty(item.id, e.target.value)} className="w-12 p-1 border rounded text-center" min="0"/></td>
                                  <td className="p-2 text-right">S/{item.price}</td>
                                  <td className="p-2 text-right font-bold">S/{(item.price * item.qty).toLocaleString()}</td>
                                  <td className="p-2 text-center"><button onClick={() => removeItem(item.id)} className="text-red-400 hover:text-red-600"><i className="fa-solid fa-trash"></i></button></td>
                               </tr>
                            ))}
                         </tbody>
                      </table>
                   </div>
                </div>

                {/* Totales */}
                <div className="bg-[#002855] text-white p-5 rounded-xl shadow-lg border-t-4 border-[#FFC72C]">
                    <div className="grid grid-cols-3 gap-4 text-center text-xs uppercase mb-4 border-b border-white/10 pb-4">
                        <div>
                           <div className="text-slate-400 mb-1">Costo Directo</div>
                           <div className="font-mono text-lg">S/ {costoDirecto.toLocaleString()}</div>
                        </div>
                        <div>
                           <label className="text-slate-400 block mb-1">Gastos Gral (%)</label>
                           <input type="number" value={gg} onChange={e=>setGG(Number(e.target.value))} className="w-12 bg-transparent border-b border-white text-center font-bold outline-none"/>
                        </div>
                        <div>
                           <label className="text-slate-400 block mb-1">Utilidad (%)</label>
                           <input type="number" value={util} onChange={e=>setUtil(Number(e.target.value))} className="w-12 bg-transparent border-b border-white text-center font-bold outline-none"/>
                        </div>
                    </div>
                    <div className="flex justify-between items-end">
                        <span className="text-xl font-campaign text-[#FFC72C]">PRESUPUESTO TOTAL</span>
                        <span className="text-5xl font-bold font-campaign drop-shadow">S/ {total.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                    </div>
                </div>
             </div>
          </div>
       );
    };

    const root = ReactDOM.createRoot(document.getElementById('root-presupuesto'));
    root.render(<BudgetTool />);
  </script>

</body>
</html>
